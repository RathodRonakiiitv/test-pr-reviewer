name: AI Code Review

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Fetch base branch
        run: git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Review with Gemini
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const { execSync } = require('child_process');
            
            // Get the diff between base and head
            const baseSha = '${{ github.event.pull_request.base.sha }}';
            const headSha = '${{ github.event.pull_request.head.sha }}';
            
            let diff;
            try {
              diff = execSync(`git diff ${baseSha}...${headSha} -- "*.py"`, { encoding: 'utf8' });
            } catch (e) {
              console.log('Diff command failed, trying alternate method...');
              diff = execSync(`git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- "*.py"`, { encoding: 'utf8' });
            }
            
            if (!diff.trim()) {
              console.log('No Python file changes to review');
              // Post a comment anyway to confirm workflow worked
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ü§ñ AI Code Review\n\nNo Python file changes detected in this PR.`
              });
              return;
            }
            
            console.log('Found diff of length:', diff.length);
            
            // Call Gemini API
            const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + process.env.GEMINI_API_KEY, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: `You are a senior code reviewer. Review the following Python code changes and identify:
            1. Potential bugs and logic errors
            2. Security vulnerabilities  
            3. Missing error handling
            4. Best practice violations
            
            Provide specific, actionable feedback with line numbers where applicable. Be concise but thorough.
            
            Code diff:
            \`\`\`diff
            ${diff}
            \`\`\``
                  }]
                }]
              })
            });
            
            const data = await response.json();
            console.log('API Response status:', response.status);
            
            if (data.error) {
              console.log('Gemini API Error:', JSON.stringify(data.error));
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ü§ñ AI Code Review\n\n‚ö†Ô∏è API Error: ${data.error.message}`
              });
              return;
            }
            
            const review = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No review generated';
            
            // Post comment on PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ü§ñ AI Code Review (Gemini)\n\n${review}\n\n---\n*Powered by Google Gemini AI*`
            });
            
            console.log('Review posted successfully!');
