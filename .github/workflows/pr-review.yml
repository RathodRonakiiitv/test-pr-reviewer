name: AI Code Review

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41

      - name: Review with Gemini
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const { execSync } = require('child_process');
            
            // Get the diff
            const diff = execSync('git diff origin/main...HEAD -- "*.py"', { encoding: 'utf8' });
            
            if (!diff.trim()) {
              console.log('No Python file changes to review');
              return;
            }
            
            // Call Gemini API
            const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + process.env.GEMINI_API_KEY, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{
                  parts: [{
                    text: `You are a senior code reviewer. Review the following code changes and identify:
            1. Potential bugs and errors
            2. Security vulnerabilities  
            3. Performance issues
            4. Best practice violations
            
            Provide specific, actionable feedback. Be concise.
            
            Code diff:
            ${diff}`
                  }]
                }]
              })
            });
            
            const data = await response.json();
            
            if (data.error) {
              console.log('Gemini API Error:', data.error.message);
              return;
            }
            
            const review = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No review generated';
            
            // Post comment on PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ¤– AI Code Review (Gemini)\n\n${review}\n\n---\n*Powered by Google Gemini AI*`
            });
            
            console.log('Review posted successfully!');
