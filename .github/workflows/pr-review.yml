name: AI Code Review

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug info
        run: |
          echo "Base ref: ${{ github.event.pull_request.base.ref }}"
          echo "Head ref: ${{ github.event.pull_request.head.ref }}"
          echo "Base SHA: ${{ github.event.pull_request.base.sha }}"
          echo "Head SHA: ${{ github.event.pull_request.head.sha }}"
          git log --oneline -5
          echo "=== Files changed ==="
          git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} || echo "Direct diff failed, trying alternate method"
          git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD
          echo "=== Python diff ==="
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- "*.py" | head -100

      - name: Review with Gemini
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const { execSync } = require('child_process');
            
            console.log('Starting Gemini review...');
            console.log('API Key exists:', !!process.env.GEMINI_API_KEY);
            console.log('API Key length:', process.env.GEMINI_API_KEY?.length || 0);
            
            // Get the diff
            let diff;
            try {
              diff = execSync('git diff origin/main...HEAD -- "*.py"', { encoding: 'utf8' });
              console.log('Diff length:', diff.length);
            } catch (e) {
              console.log('Error getting diff:', e.message);
              diff = '';
            }
            
            if (!diff.trim()) {
              console.log('No Python file changes to review');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ü§ñ AI Code Review\n\nNo Python file changes detected in this PR.\n\n*Debug: Workflow completed successfully*`
              });
              return;
            }
            
            console.log('Found Python diff, calling Gemini API...');
            console.log('First 200 chars of diff:', diff.substring(0, 200));
            
            // Call Gemini API
            const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + process.env.GEMINI_API_KEY;
            
            try {
              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  contents: [{
                    parts: [{
                      text: `You are a senior code reviewer. Review the following Python code changes and identify:
            1. Potential bugs and logic errors
            2. Security vulnerabilities  
            3. Missing error handling
            4. Best practice violations
            
            Provide specific, actionable feedback. Be concise but thorough.
            
            Code diff:
            \`\`\`diff
            ${diff}
            \`\`\``
                    }]
                  }]
                })
              });
              
              console.log('API Response status:', response.status);
              const data = await response.json();
              console.log('API Response:', JSON.stringify(data).substring(0, 500));
              
              if (data.error) {
                console.log('Gemini API Error:', JSON.stringify(data.error));
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `## ü§ñ AI Code Review\n\n‚ö†Ô∏è API Error: ${data.error.message}\n\n*Please check if GEMINI_API_KEY secret is set correctly*`
                });
                return;
              }
              
              const review = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No review generated';
              
              // Post comment on PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ü§ñ AI Code Review (Gemini)\n\n${review}\n\n---\n*Powered by Google Gemini AI*`
              });
              
              console.log('Review posted successfully!');
            } catch (e) {
              console.log('Error calling API:', e.message);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ü§ñ AI Code Review\n\n‚ö†Ô∏è Error: ${e.message}`
              });
            }
